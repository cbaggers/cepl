(in-package :cepl.stencil)

(defvar *valid-stencil-tests*
  '(:never :always :less :lequal :greater :gequal :equal :notequal
    #'never #'always #'< #'<= #'> #'>= #'= #'/=))

(defvar *valid-operations*
  '(:keep :invert :zero :replace :incr :incr-wrap :decr :decr-wrap
    #'keep #'zero #'stencil-replace #'stencil-invert
    #'stencil-incf #'stencil-incf-wrap
    #'stencil-decf #'stencil-decf-wrap))


(defn stencil-test-to-enum ((test (or function keyword)))
    (signed-byte 32)
  (declare (optimize (speed 3) (safety 1) (debug 1))
           (profile t))
  (cond
    ((or (eq test :never) (eq test #'never))
     #.(gl-enum :never))
    ((or (eq test :always) (eq test #'always))
     #.(gl-enum :always))
    ((or (eq test :less) (eq test #'<))
     #.(gl-enum :less))
    ((or (eq test :lequal) (eq test #'<=))
     #.(gl-enum :lequal))
    ((or (eq test :greater) (eq test #'>))
     #.(gl-enum :greater))
    ((or (eq test :gequal) (eq test #'>=))
     #.(gl-enum :gequal))
    ((or (eq test :equal) (eq test #'=))
     #.(gl-enum :equal))
    ((or (eq test :notequal) (eq test #'/=))
     #.(gl-enum :notequal))
    (t (error "CEPL: The stencil test must be one of the following:狺鲠扉洵篝孱汩飙翦篝螵┅┅ㄤ彐篝孱汩飙镳弪狒轱瞽麸孱蹴è镳弪狒轱矧骢钽糸镱脲黠蜾┅箝珙邃怡翦巢ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴痱镦殪舂ㄣ镱è矧ㄥ镳弪狒轱弘邋皓ㄥ镳弪狒轱＇脲屦┅．ㄧ飙孱蹴弘邋皓è矧ㄥ镳弪狒轱洪铞弪舂ㄥ镳弪狒轱＇篝孱汩飙轭鲥螋┅．ㄧ飙孱蹴洪铞弪舂è矧ㄥ镳弪狒轱胡弪铹ㄥ镳弪狒轱＇弪铹．ㄧ飙孱蹴胡弪铹è矧ㄥ镳弪狒轱候屦灬沐ㄥ镳弪狒轱＇篝孱汩飙蝈痨徙濠．ㄧ飙孱蹴候屦灬沐┅è矧ㄥ镳弪狒轱洪钽颟ㄥ镳弪狒轱＇篝孱汩飙轭沔┅．ㄧ飙孱蹴洪钽颟è矧ㄥ镳弪狒轱洪钽颦黩狃ㄥ镳弪狒轱＇篝孱汩飙轭沔黩狃┅．ㄧ飙孱蹴洪钽颦黩狃┅è矧ㄥ镳弪狒轱轰邈颟ㄥ镳弪狒轱＇篝孱汩飙溴沔┅．ㄧ飙孱蹴轰邈颟è矧ㄥ镳弪狒轱轰邈颦黩狃ㄥ镳弪狒轱＇篝孱汩飙溴沔黩狃┅．ㄧ飙孱蹴轰邈颦黩狃┅ㄥ蝌矧⒚判毯澡篝孱汩镳弪狒轱眭篝忮镱镦翳骘祆秣轭绾狺鲠扉洵篝孱汩飙翦篝螵┅┅换换零沐篌矧ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢翦篝è疳蜥眢篝孱汩飙疳蜥眢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅篝孱汩飙翦篝孱蹴麸骢钽ē篝孱汩飙疳蜥眢翦篝疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢鲠祯è疳蜥眢篝孱汩飙疳蜥眢┅躅箝珙邃怡翦俯ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅ē篝孱汩飙疳蜥眢鲠祯疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢磲箅è疳蜥眢篝孱汩飙疳蜥眢┅躅箝珙邃怡翦俯ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅ē篝孱汩飙疳蜥眢磲箅疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢镱篝孱汩飙翦篝驷殪è疳蜥眢篝孱汩飙疳蜥眢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅篝孱汩飙镳弪狒轱瞽孱蹴麸骢钽ē篝孱汩飙疳蜥眢镱篝孱汩飙翦篝驷殪疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝驷殪è疳蜥眢篝孱汩飙疳蜥眢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅篝孱汩飙镳弪狒轱瞽孱蹴麸骢钽ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝驷殪疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝疳篌è疳蜥眢篝孱汩飙疳蜥眢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅篝孱汩飙镳弪狒轱瞽孱蹴麸骢钽ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝疳篌疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢镱箧衢è疳蜥眢篝孱汩飙疳蜥眢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅篝孱汩飙镳弪狒轱瞽孱蹴麸骢钽ē篝孱汩飙疳蜥眢镱篝孱汩飙翦篝驷殪疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢镱漯驷殪è疳蜥眢篝孱汩飙疳蜥眢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅篝孱汩飙镳弪狒轱瞽孱蹴麸骢钽ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝驷殪疳蜥眢┅ㄤ彐瞽轭扉铄篝孱汩飙疳蜥眢镱漯疳篌è疳蜥眢篝孱汩飙疳蜥眢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴┅篝孱汩飙镳弪狒轱瞽孱蹴麸骢钽ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝疳篌疳蜥眢┅换ㄤ彐篝孱汩飙翦篝孱蹴麸骢钽è孱蹴箝珙邃怡翦巢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴痱镦殪舂ㄥ汜箦孱蹴ǎㄧ飙孱蹴侯弼弪＇铄鲥颟ǎㄧ飙孱蹴横祺狴螬＇犰麽螬ǎㄧ飙孱蹴红弩螬＇缉ǎㄧ飙孱蹴红羼踽飑＇冀ǎㄧ飙孱蹴虹蝈狒弪＇京ǎㄧ飙孱蹴虹羼踽飑＇窘ǎㄧ飙孱蹴哄聃犰＇僵ǎㄧ飙孱蹴侯雉羼踽飑＇僵┅ㄤ彐篝孱汩飙镳弪狒轱瞽孱蹴麸骢钽è孱蹴箝珙邃怡翦巢┅骢钽糸镱ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴痱镦殪舂ㄥ汜箦孱蹴ǎㄧ飙孱蹴弘邋皓＇脲屦ǎㄧ飙孱蹴洪铞弪舂＇篝孱汩飙轭鲥螋ǎㄧ飙孱蹴胡弪铹＇弪铹ǎㄧ飙孱蹴候屦灬沐＇篝孱汩飙蝈痨徙濠ǎㄧ飙孱蹴洪钽颟＇篝孱汩飙轭沔ǎㄧ飙孱蹴洪钽颦黩狃＇篝孱汩飙轭沔黩狃ǎㄧ飙孱蹴轰邈颟＇篝孱汩飙溴沔ǎㄧ飙孱蹴轰邈颦黩狃＇篝孱汩飙溴沔黩狃┅ㄤ彐磲脲篝孱汩飙疳蜥眢é脲翦篝矧骢钽糸镱脲黠蜾＇铄鲥颟鲠祯躅箝珙邃怡翦俯癌磲箅躅箝珙邃怡翦俯癌镱篝孱汩飙翦篝驷殪矧骢钽糸镱脲黠蜾＇脲屦镱篝孱汩飙疳篌溴痿璀翦篝驷殪矧骢钽糸镱脲黠蜾＇脲屦镱篝孱汩飙疳篌溴痿璀翦篝疳篌矧骢钽糸镱脲黠蜾＇脲屦┅篝孱汩飙疳蜥眢ㄡ篌弪豉疱鲠祯Ж躅箝珙邃怡翦俯┅ㄡ篌弪豉疱磲箅Ж躅箝珙邃怡翦俯┅ē磲脲篝孱汩飙疳蜥眢呼弩篝孱汩飙翦篝麸孱蹴翦篝忽犰蹂鲠祯喉狍磲箅猴瞽篝孱汩飙翦篝驷殪篝孱汩飙镳弪狒轱瞽麸孱蹴镱篝孱汩飙翦篝驷殪猴瞽篝孱汩飙疳篌溴痿璀翦篝驷殪篝孱汩飙镳弪狒轱瞽麸孱蹴镱篝孱汩飙疳篌溴痿璀翦篝驷殪猴瞽篝孱汩飙疳篌溴痿璀翦篝疳篌篝孱汩飙镳弪狒轱瞽麸孱蹴镱篝孱汩飙疳篌溴痿璀翦篝疳篌┅ㄤ彐礤翳镤痱轭舡镡赍泗è箴篝孱汩飙疳蜥眢篝蝈犴痱轭舡躅蝈徜徕戾镡赍泗箴篝蝈犴ㄦ矧磲篝蝈犴兰釉盼蒙汰辛伊陀豪吆耘釉窿豪吆至陶窿豪吆土铀窿豪吆衔釉盼蒙汰耘釉屏商窿豪吆衔釉盼蒙汰辛佑呐性拳耘釉屏商豪吆衔釉盼蒙汰辛佑呐性拳耘釉辛佑窿壕篝孱汩飙疳蜥眢翦篝箴篝孱汩飙疳蜥眢鲠祯箴篝孱汩飙疳蜥眢磲箅箴篝孱汩飙疳蜥眢镱篝孱汩飙翦篝驷殪箴篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝驷殪箴篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝疳篌箴┅┅ㄤ彐メ痧禊篝孱汩飙疳蜥眢è驷沐箝珙邃怡翦巢┅疳蜥眢篝孱汩飙疳蜥眢ㄣ屦飙泔铘屮沐痨泔铘屮舂鲠祯弩ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴痱镦殪舂ē鏖翳沐痨泔铘屮舡箪雉ㄣ躜蝈铘篝孱汩飙疳蜥眢骝镱沲蝌孱舡篝孱汩飙疳蜥眢忉汶沐痨泔铘屮换换躔溽翦泔铘屮戾è沲蝌孱ㄣ镱è驷沐．ㄧ飙孱蹴烘蝻铘┅痱镧沲蝌孱舡篝孱汩飙疳蜥眢骝镱箦翩沲蝌孱舡篝孱汩飙疳蜥眢骝镱疳蜥眢┅è驷沐．ㄧ飙孱蹴衡徙氅痱镧沲蝌孱舡篝孱汩飙疳蜥眢忉汶箦翩沲蝌孱舡篝孱汩飙疳蜥眢忉汶疳蜥眢┅箦翩沲蝌孱舡篝孱汩飙疳蜥眢骝镱疳蜥眢箦翩沲蝌孱舡篝孱汩飙疳蜥眢忉汶疳蜥眢铋飑┅换换躔溽翦珈躅戾篌ㄥ疳蜥眢沲蝌孱舂躅戾篌矧ǒē篝孱汩飙疳蜥眢翦篝疳蜥眢ē篝孱汩飙疳蜥眢翦篝沲蝌孱舂ǒē篝孱汩飙疳蜥眢鲠祯疳蜥眢ē篝孱汩飙疳蜥眢鲠祯沲蝌孱舂ǒē篝孱汩飙疳蜥眢磲箅疳蜥眢ē篝孱汩飙疳蜥眢磲箅沲蝌孱舂┅ㄧ旌篝孱汩飙骢钽箦疳蜥翦驷沐篝孱汩飙疳蜥眢翦篝疳蜥眢篝孱汩飙疳蜥眢鲠祯疳蜥眢篝孱汩飙疳蜥眢磲箅疳蜥眢┅躅戾篌矧ǒē篝孱汩飙疳蜥眢镱篝孱汩飙翦篝驷殪疳蜥眢ē篝孱汩飙疳蜥眢镱篝孱汩飙翦篝驷殪沲蝌孱舂ǒē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝驷殪疳蜥眢ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝驷殪沲蝌孱舂ǒē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝疳篌疳蜥眢ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝疳篌沲蝌孱舂┅ㄧ旌篝孱汩飙镳箦疳蜥翦驷沐ē篝孱汩飙疳蜥眢镱篝孱汩飙翦篝驷殪疳蜥眢ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝驷殪疳蜥眢ē篝孱汩飙疳蜥眢镱篝孱汩飙疳篌溴痿璀翦篝疳篌疳蜥眢┅┅┅鲠祯弩┅ㄤ彐狃痨篝孱汩飙疳蜥眢è驷沐簌礅镬疳蜥眢篝孱汩飙疳蜥眢镳糸镱犰ㄣ屦飙泔铘屮沐痨泔铘屮ㄣ屦飙泔铘屮舂┅篝孱汩飙疳蜥眢ㄤ邈灬蝈镳糸黹箴邋畅筢驽豉暴ㄤ邂蹒暴痱镦殪舂戾è孱蹴ㄥ汜箦驷沐ê骝镱．ㄧ飙孱蹴烘蝻铘┅ê忉汶．ㄧ飙孱蹴衡徙氅ê骝镱舡犷洵忉汶．ㄧ飙孱蹴烘蝻铘犷洵忉汶┅┅ē狃痨篝孱汩飙疳蜥眢孱蹴疳蜥眢沐痨泔铘屮舂疳蜥眢ㄤ彐轭瀛泔眇殪弪磲泸狃痨篝孱汩飙疳蜥眢é麒镬麒镬驷沐疳蜥眢镳糸镱犰沐痨泔铘屮舂戾è孱蹴ㄣ狍驷沐ê骝镱．ㄧ飙孱蹴烘蝻铘┅ê忉汶．ㄧ飙孱蹴衡徙氅ê骝镱舡犷洵忉汶．ㄧ飙孱蹴烘蝻铘犷洵忉汶┅雉桢蝼轶驷沐┅┅ㄣ镱è簌礅镬孱蹴麒镬濠ㄣ屦飙泔铘屮啜メ痧禊篝孱汩飙疳蜥眢孱蹴疳蜥眢沐痨泔铘屮舂啜メ痧禊篝孱汩飙疳蜥眢孱蹴疳蜥眢ㄣ屦飙泔铘屮舂┅┅